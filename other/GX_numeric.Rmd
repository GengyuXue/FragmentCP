---
title: "GX_numeric"
output: html_document
date: "2024-04-03"
---
```{r}
lambda = 0.00005
# lambda = 0.0001
# lambda = 0
ext = 0.05
maxIt = 1
r1 = 3
r2 = 3
sigma1 = 1
sigma2 = 1
Delta = 50
regular_grid = seq(0.05, 0.95, length.out = 50)
```

Simulate data: 
```{r}
data1 = temp_fragment_data6(mu = 0, r = r1, sigma1, n = 100, m = 30, sigma_epsilon = 0.1, domain = c(0, 1), delta = 0.5)
data2 = temp_fragment_data5(mu = 0, r = r2, sigma2, n = 100, m = 30, sigma_epsilon = 0.1, domain = c(0, 1), delta = 0.5)
data = list("t"= rbind(data1$t, data2$t), "y" = rbind(data1$y, data2$y), "r" = cbind(data1$r, data2$r))
```

Estimatoin (data1):
```{r}
cov.obj1 = cov_basis(data1$t, data1$y, data1$r, r1, lambda, ext, maxIt) # estimate covariance function
C_est1 <- cov.obj1$C
C_est1
cov_est1 = predict_cov(regular_grid, C_est1)
cov.obj1$error
# obtain the true covariance function
# dist_mat = dist(1:r1, method = "manhattan", diag = T, upper = T)

C_1 = matrix(0, nrow = r1, ncol = r1)
diag(C_1) = seq(from = 20, by = -6, length.out = r1)

# C_1 <-  matrix(0, nrow = r1, ncol = r1)
# diag(C_1) <- (1:r1)^(-1)

#C_1 <- as.matrix(2^(-dist_mat - 5/2)) + diag(1.5^(1-(1:r1)))
C_1
cov1 = predict_cov(regular_grid, C_1)
# compare
mean((cov_est1 - cov1)^2)
```


Estimation (data2):
```{r}
cov.obj2 = cov_basis(data2$t, data2$y, data2$r, r2, lambda, ext, maxIt)
C_est2 <- cov.obj2$C
C_est2
cov.obj2$error
cov_est2 = predict_cov(regular_grid, C_est2)
C_2 = matrix(0, nrow = r, ncol = r)
diag(C_2) = seq(from = 30, by = -8, length.out = r)
C_2
cov2 = predict_cov(regular_grid, C_2)
mean((cov_est2 - cov2)^2)
#sum((cov_est2 - cov2)^2)/sum(cov2^2)
```




Jump size:
```{r}
mean((cov1 - cov2)^2)
mean((cov_est1 - cov_est2)^2)
```


Using both data:
```{r}
cov.obj = cov_basis(data$t, data$y, data$r, r1, lambda, ext, maxIt)
C_est <- cov.obj$C
cov.obj$error
cov_est = predict_cov(regular_grid, C_est, ext)
mean((cov_est - cov1)^2)
mean((cov_est - cov2)^2)
mean((cov_est - (cov1+cov2)/2)^2)
```

Using part of the data:
```{r}
cov.obj_whole <- cov_basis(data$t[1:100,], data$y[1:100,], data$r[,1:3000], r1, lambda, ext, maxIt)
cov.obj_first <- cov_basis(data$t[1:50,], data$y[1:50,], data$r[,1:1500], r1, lambda, ext, maxIt)
cov.obj_second <- cov_basis(data$t[51:100,], data$y[51:100,], data$r[, 1501:3000], r1, lambda, ext, maxIt)

cov.obj_whole <- cov_basis(data$t[101:200,], data$y[101:200,], data$r[ ,3001:6000], r1, lambda, ext, maxIt)
cov.obj_first <- cov_basis(data$t[101:150,], data$y[101:150,], data$r[ ,3001:4500], r1, lambda, ext, maxIt)
cov.obj_second <- cov_basis(data$t[151:200,], data$y[151:100,], data$r[, 4501:6000], r1, lambda, ext, maxIt)

cov.obj_whole$error
cov.obj_first$error
cov.obj_second$error


cov.obj_whole$C
cov.obj_first$C
cov.obj_second$C

C_est <- cov.obj$C
cov_est = predict_cov(regular_grid, C_est, ext)
mean((cov_est - cov1)^2)
mean((cov_est - cov2)^2)
mean((cov_est - (cov1+cov2)/2)^2)
```


Change point:
```{r}
cpt_result = DP_fragment(data$t, data$y, data$r, r = 3, lambda, xi = 5000, ext, maxIt, Delta=30)
cpt_result$partition
cpt_result$bestvalue
part2local(cpt_result$partition)
```







